# Kubernetes 인증/인가

## 인증/인가

- 인증
    - x509 Client Certificate
    - Bearer Token
        - 서비스 어카운트 토큰
        - Static Token 파일 (거의 사용 X)
    - OpenID Connect (OIDC)
    - Webhook Token Authentication
        - 토큰의 검증을 외부 서비스에 위임
- 인가
    - RBAC
        - 가장 일반적인 권한 모델

## 서비스 어카운트 

- Pod가 쿠버네티스 API 서버와 통신하도록 하기 위한 내부용 계정
- Pod가 생성될 때 자동으로 1개 서비스 어카운트를 할당 (default SA)
- RBAC(Role/ClusterRole) 권한이 SA에 바인딩

## Role과 ClusterRole

- Role: 특정 namespace 내부에서만 권한을 정의
    ```
    kind: Role
    apiVersion: rbac.authorization.k8s.io/v1
    metadata:
        namespace: dev
    name: pod-reader
    rules:
      - apiGroups: [""]
        resources: ["pods"]
        verbs: ["get", "list"]
    ```
- ClusterRole: 전체 클러스터를 대상으로 권한을 정의
    ```
    kind: ClusterRole
    apiVersion: rbac.authorization.k8s.io/v1
    metadata:
        name: view-nodes
    rules:
      - apiGroups: [""]
        resources: ["nodes"]
        verbs: ["get", "list"]
    ```
- Binding: SA와 Role/ClusterRole 연결
    - RoleBinding → Role ↔ ServiceAccount 연결 (namespace 제한)
    - ClusterRoleBinding → ClusterRole ↔ ServiceAccount 연결 (클러스터 전체)

예:

```
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
    name: read-pods
    namespace: dev
subjects:
- kind: ServiceAccount
    name: app-sa
    namespace: dev
roleRef:
    kind: Role
    name: pod-reader
    apiGroup: rbac.authorization.k8s.io
```

## Kubernetes API 서버 접근 방법

### 서비스 어카운트의 Secret(토큰)을 이용

- SA에는 JWT 토큰이 부여되어 있음
- Kubernetes 1.24 이전
    - SA 생성 시 Secret이 자동 생성되어
    - Pod에 자동 마운트되었음
- Kubernetes 1.24 이후
    - Secret이 자동 생성되지 않고
    - TokenRequest API로 동적 토큰 발급이 기본

### 클러스터 내부의 쿠버네티스 서비스를 통해

- API 서버를 다음과 같이 기본 서비스로 노출함
    `https://kubernetes.default.svc`
- Pod 내부에서는 자동으로 다음 환경 정보가 제공됨
    ```
    KUBERNETES_SERVICE_HOST
    KUBERNETES_SERVICE_PORT_HTTPS
    ```
- Pod에서: `curl -k https://kubernetes.default.svc`

### 쿠버네티스 SDK를 이용해 Pod 내부에서 API 서버에 접근

- SDK의 in-cluster configuration 기능을 이용

### API 서버 접근 흐름 요약

1. Pod 실행 → 서비스 어카운트가 기본 연결
2. 토큰/CA 파일이 자동 마운트
    - 여기서 CA 파일은 서버 인증서를 위함
3. API Endpoint는 kubernetes.default.svc
4. SDK 또는 curl로 Bearer 토큰 인증
5. Role/ClusterRole을 통해 권한 결정
6. Kubernetes API 호출 수행

```
Pod
 └── ServiceAccount (JWT Token + CA)
        ↓ 인증
   [Kubernetes API Server]
        ↓ 인가(RBAC)
   Role / ClusterRole
        ↓ 허용 또는 거부
   요청 처리
```
