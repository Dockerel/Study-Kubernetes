# 커스텀 리소스, 컨트롤러, 잡, 데몬셋, 스테이트풀셋

## 커스텀 리소스와 컨트롤러

### 쿠버네티스 컨트롤러의 개념과 동작 방식

쿠버네티스 컨트롤러: 클러스터의 실제 상태가 사용자가 선언한 상태에 지속적으로 수렴하도록 유지하는 제어 루프 컴포넌트

1. 현재 상태 관찰: API 서버를 통해 리소스의 실제 상태를 확인
    - 실제로는 API 서버의 부하 감소와 속도 향상을 위해 Informer로부터 가져옴
    - Informer는 상태를 watch하고 이를 저장할 캐시 스토리지가 있음
2. 의도한 상태와 비교: 사용자가 정의한 스펙(spec)과 현재 상태를 비교
3. 차이 조정 (조정 루프): 차이가 존재할 경우 필요한 작업을 수행하여 상태를 원하는 형태로 복원
    - Reconcile라는 함수를 이용

위의 과정은 지속적으로 반복됨

### 커스텀 리소스의 개념

- 쿠버네티스 API를 확장하여 사용자 정의 오브젝트를 추가할 수 있는 메커니즘
    - 쿠버네티스 API에 새로운 리소스 타입을 추가
    - 선언적 구성 방식으로 외부 시스템 또는 복잡한 컴포넌트를 제어
    - 특정 도메인의 운영 자동화 구현

#### CRD (Custom Resource Definition)

- 커스텀 리소스를 쿠버네티스에 등록하기 위한 스키마 정의 객체
- CRD를 적용하면 API 서버는 새로운 리소스 타입을 인식하고 저장 및 조회 가능
- CRD에 포함된 요소
    - 리소스 이름 및 API 그룹
    - 버전 관리 (v1, v1beta1 등)
    - 스키마 검증 (OpenAPI v3 기반)

### Operator 패턴

- 커스텀 리소스와 컨트롤러를 결합하면 생기는 패턴
- 특정 애플리케이션이나 시스템의 운영 작업(배포, 백업, 장애 복구, 스케일링 등)을 자동화하는 쿠버네티스 네이티브 구성 요소

## Pod을 사용하는 오브젝트들

쿠버네티스는 애플리케이션을 실행하기 위해 pod을 직접 관리하는 대신 다양한 상위 오브젝트를 제공함

### 잡 (Jobs)

- 유한 작업을 수행하기 위한 리소스
- 지정된 pod이 성공적으로 종료될 때까지 작업을 관리함
- 일회성 또는 batch 작업에 적합
- 병렬 처리 가능
- 작업이 성공적으로 완료되면 더 이상 pod을 유지하지 않음

### 데몬셋 (DaemonSets)

- 클러스터의 모든 노드 또는 특정 노드 그룹마다 정확히 하나의 pod이 실행되도록 보장
- 노드 추가 시 자동으로 pod이 해당 노드에 생성
- 노드 삭제 시 pod도 삭제
- 노드 단위 기능을 제공하는 시스템 에이전트 배포에 적합

### 스테이트풀셋 (StatefulSets)

- 상태를 유지해야 하는 애플리케이션을 위해 설계된 리소스
- pod마다 고유하고 안정적인 ID를 제공
- pod 이름이 순서대로 부여되고 재시작해도 동일한 이름 유지
- pod마다 고유한 PV가 제공됨 (데이터 지속성 보장)
- pod의 생성, 업데이트, 삭제가 순차적으로 이루어짐
- 클러스터링이 필요한 분산 시스템, 데이터베이스 등에 적합

## Reference

- [쿠버네티스 커스텀 리소스 정의하고 관리하기](https://techblog.lycorp.co.jp/ko/define-and-manage-kubernetes-custom-resources-with-controller)
