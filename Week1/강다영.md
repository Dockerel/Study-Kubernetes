# 쿠버네티스

## 개요

- 컨테이너화된 app의 배포/확장/관리 &rarr; 자동화
- 여러 대의 서버(노드)로 구성된 클러스터 환경에서 컨테이너의 상태 관리/스케줄링/장애 시 복구를 담당
- 주요 특징
  - 자동화된 배포 및 롤백
  - 자동 스케일링: pod 수 자동 조절
  - 자가 복구: 장애가 발생한 컨테이너를 자동으로 재시작 혹은 교체
  - pod IP가 동적으로 바뀌어도 서비스 이름으로 접근 가능
  - 트래픽을 자동 분산
  - CPU, 메모리 등 리소스 사용량을 제어해 효율적인 운영 가능

> [!NOTE]
> 1. 컨테이너화된 app이 도커를 칭하는 건가?
> 2. 오케스트레이션의 정의

## 전체 구조

### 리소스 관점
 
![structure](./structure.drawio.svg)

- pod: 배포할 수 있는 가장 작은 단위, 하나 이상의 컨테이너를 가짐
- rs: deployment의 명령에 따라 실제 pod 수 관리
- deployment: 사용자가 원하는 app의 상태 정의
- service: 여러 pod 간의 네트워크 접근을 제공하는 추상화 계층
- ingress: 외부 트래픽을 클러스터 내부의 서비스로 라우팅하는 리소스

### 시스템 관점

> [!NOTE]
> 클러스터는 노드(최소 2개 이상)로 구성, 노드는 아래 두 종류가 있음

- Control Plane: 클러스터 전체를 제어
  - kube-apiserver: 쿠버네티스 API를 제공하는 핵심 엔드포인트. 모든 구성 요소가 이 API를 통해 통신함.
  - etcd: 클러스터의 모든 상태 정보를 저장하는 분산 키-값 저장소 (예: 어떤 pod가 어디서 실행 중인지 등)
  - kube-scheduler: pod를 어떤 노드에 배치할지 결정함 (리소스 사용량, 정책 등을 고려)
  - kube-controller-manager: 클러스터의 실제 상태를 원하는 상태(deployment, rs 등)에 맞게 조정하는 컨트롤러들의 집합
  - cloud-controller-manager: 클라우드 제공자(GCP, AWS 등)와의 통합을 담당
- Worker Node: pod가 실행되는 서버
  - kubelet: 각 노드에서 pod가 제대로 실행되고 있는지 확인하고, API 서버와 통신
  - kube-proxy: 클러스터 내부 네트워크 트래픽을 관리하고, 서비스의 로드밸런싱을 수행
  - Container Runtime: 실제 컨테이너를 실행시키는 엔진 (예: Docker, containerd, CRI-O 등)

## 도커와의 관계

- Dockerfile을 작성하여 도커 이미지를 빌드
- 빌드된 이미지를 Docker Hub나 Private Registry에 저장
- 쿠버네티스에서 deployment를 정의할 때, 이 도커 이미지를 가져와 pod 생성

## 배포 리소스 정의

### deployment 정의

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp-container
        image: <registry>/<image>:<tag>
        ports:
        - containerPort: 80
```

### service 정의

```yaml
apiVersion: v1
kind: Service
metadata:
  name: myapp-service
spec:
  selector:
    app: myapp
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
  type: ClusterIP
```

### ingress 정의 (필요 시)

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: myapp-ingress
spec:
  rules:
  - host: myapp.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: myapp-service
            port:
              number: 80
```

## 쿠버네티스에 배포

### deployment, service, ingress 적용

```
kubectl apply -f deployment.yaml
kubectl apply -f service.yaml
kubectl apply -f ingress.yaml
```

### 리소스 상태 확인

```
kubectl get pods
kubectl get svc
kubectl get ingress
kubectl describe pod <pod 이름>
```

### 로그 확인

```
kubectl logs
```
