# Volumn

- 컨테이너 내 디스크에 있는 파일은 임시적
    - 컨테이너가 크래시될 때 파일이 손실됨
    - Pod에서 같이 실행되는 컨테이너 간의 파일 공유가 어려움
- 이를 해결하기 위해 volumn이 등장
    - Pod는 여러 volumn 유형을 동시에 사용 가능
    - Persistant volumn은 Pod의 수명과 관계 없이 존재
    - 기본적으로 **컨테이너의 생명주기와 스토리지의 생명주기를 구분**하기 위해 도입
- Volumn은 디렉토리임
    - Pod 내의 컨테이너에서 접근 가능
    - 디렉토리 생성 방식과 지원하는 매체/내용은 volumn 유형에 따라 결정됨
    - 쿠버네티스는 여러 유형의 volumn을 지원함

## How to use

- `.spec.volumes` 에서 pod에 제공할 volumn 지정
- `spec.containers[*].volumeMounts` 의 컨테이너에 해당 볼륨을 마운트할 위치를 선언
- Pod에서 정의된 각 컨테이너에 대해 사용할 volumn을 어디에 마운트할지 명시해야 함
- 주의 사항
    - Volumn은 다른 volumn 안에 마운트될 수 없음
    - Volumn은 다른 volumn에 있는 내용물을 가리키는 하드 링크를 포함할 수 없음

# Persistant Volumn

- Persistent Volume(PV)은 클러스터 내에서 관리되는 실제 스토리지 자원을 의미함
- 쿠버네티스 클러스터 안에서 하나의 독립적인 스토리지 객체로 취급
- 예시
    ```yaml
    apiVersion: v1
    kind: PersistentVolume
    metadata:
        name: my-pv
    spec:
        capacity:
            storage: 5Gi
        accessModes:
            - ReadWriteOnce
        persistentVolumeReclaimPolicy: Retain
        hostPath:
            path: /mnt/data
    ```
- `persistentVolumeReclaimPolicy`: PV가 해제된 후
    - `Retain`: 데이터를 유지할지
    - `Delete`: 데이터를 삭제할지
- Pod 설정 시 직접적으로 PV를 적는 건 아님
- 동적 프로비저닝을 이용하면 PV를 만들지 않아도 됨
    - Pod → PVC → (StorageClass → PV) → 실제 스토리지
    - 다만 StorageClass (PV를 자동으로 생성하는 정책) 설정 필요
        ```yaml
        apiVersion: storage.k8s.io/v1
        kind: StorageClass
        metadata:
            name: standard
        provisioner: kubernetes.io/aws-ebs
        parameters:
            type: gp2  # EBS volumn type
        reclaimPolicy: Delete
        volumeBindingMode: Immediate
        ```
        - `volumeBindingMode` 
            - `Immediate`: PVC가 생성되는 즉시 PV(EBS 등)를 생성하고 바인딩함
            - `WaitForFirstConsumer`: PVC를 사용하는 Pod이 실제로 스케줄링될 때까지 PV 생성을 지연시킴
    - 설정한 StorageClass를 생성
        ```yaml
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
            name: my-pvc
        spec:
            accessModes:
                - ReadWriteOnce
            storageClassName: standard
            resources:
                requests:
                storage: 10Gi
        ```

> [!NOTE]
> PV가 해제된 후 = PVC와의 연결이 끊긴 후

- PVC가 만들어진 후 PV와 바인딩이 됨 (PV의 상태: `Bound`)
- Pod이 PV를 통해 읽고 씀 (PV의 상태: `Active`)
- PVC가 삭제된다면 (PV의 상태: `Released`)
    - `Released`의 상태가 되면 `persistentVolumeReclaimPolicy` 룰에 따름

# Persistant Volumn Claim

- Persistent Volume Claim(PVC)은 사용자 또는 애플리케이션이 요청하는 스토리지 요구사항을 의미함
- Pod와 어떤 면에서 유사함
    - Pod: 노드 리소스 사용
    - PVC: PV 리소스 사용
- PVC 예시
    ```yaml
    apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
        name: my-pvc
    spec:
        accessModes:
            - ReadWriteOnce
        resources:
            requests:
            storage: 5Gi
    ```
- Pod 예시
    ```yaml
    apiVersion: v1
    kind: Pod
    metadata:
        name: my-pod
    spec:
        containers:
            - name: app
            image: nginx
            volumeMounts:
                - mountPath: /usr/share/nginx/html
                  name: my-storage
    volumes:
        - name: my-storage
          persistentVolumeClaim:
            claimName: my-pvc
    ```
- 여기서 `mountPath`는 스토리지를 컨테이너 내부의 경로에 연결하는 것
    - 실제 저장 장소는 PVC와 연결된 PV에 저장됨
    - 이 PV의 저장소와 연결될 곳으로 고르는 것
    - `/usr/share/nginx/html  <-- mounted -->  /mnt/data`

# Reference

- https://kubernetes.io/ko/docs/concepts/storage/persistent-volumes/
